<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Flashcard Pro - SRS Edition</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
    :root {
        /* Light Theme */
        --primary: #4F46E5;
        --primary-light: #EEF2FF;
        --bg: #F9FAFB;
        --card-bg: #FFFFFF;
        --text-main: #111827;
        --text-sub: #6B7280;
        --border: #E5E7EB;
        --success: #10B981;
        --warning: #F59E0B;
        --danger: #EF4444;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --radius: 16px;
    }

    body.dark-mode {
        /* Dark Theme */
        --primary: #6366F1;
        --primary-light: #312E81;
        --bg: #111827;
        --card-bg: #1F2937;
        --text-main: #F3F4F6;
        --text-sub: #9CA3AF;
        --border: #374151;
        --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg);
        color: var(--text-main);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: background-color 0.3s, color 0.3s;
    }

    /* --- LAYOUT UTILS --- */
    .view {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        padding-bottom: 90px; /* Space for navbar */
        display: none;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
    }
    .view.active { display: block; opacity: 1; }

    .container { max-width: 600px; margin: 0 auto; width: 100%; }
    
    .card-box {
        background: var(--card-bg);
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        margin-bottom: 16px;
    }

    h1, h2, h3 { font-weight: 700; color: var(--text-main); }
    .text-sub { color: var(--text-sub); font-size: 0.9rem; }
    .text-primary { color: var(--primary); }

    /* --- BUTTONS --- */
    .btn {
        display: inline-flex; align-items: center; justify-content: center;
        padding: 12px 20px; border-radius: 12px;
        font-weight: 600; font-size: 0.95rem;
        cursor: pointer; border: none; outline: none;
        transition: transform 0.1s, opacity 0.2s;
        gap: 8px; width: 100%;
    }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
    .btn-secondary { background: var(--bg); color: var(--text-main); border: 1px solid var(--border); }
    .btn-ghost { background: transparent; color: var(--text-sub); }
    
    /* SRS Buttons */
    .srs-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 8px; margin-top: 20px; }
    .btn-srs { flex-direction: column; padding: 10px 5px; font-size: 0.8rem; height: 70px; }
    .btn-again { background: #fee2e2; color: #991b1b; } /* Light Red */
    .btn-hard { background: #fef3c7; color: #92400e; } /* Light Orange */
    .btn-good { background: #d1fae5; color: #065f46; } /* Light Green */
    .btn-easy { background: #dbeafe; color: #1e40af; } /* Light Blue */
    
    body.dark-mode .btn-again { background: #450a0a; color: #fca5a5; }
    body.dark-mode .btn-hard { background: #451a03; color: #fdba74; }
    body.dark-mode .btn-good { background: #064e3b; color: #6ee7b7; }
    body.dark-mode .btn-easy { background: #1e3a8a; color: #93c5fd; }

    /* --- INPUTS --- */
    input[type="text"], input[type="number"], select {
        width: 100%; padding: 12px;
        border-radius: 12px; border: 1px solid var(--border);
        background: var(--bg); color: var(--text-main);
        font-size: 1rem; margin-bottom: 10px;
    }
    input:focus { border-color: var(--primary); outline: none; }

    /* --- NAVIGATION --- */
    .nav-bar {
        position: fixed; bottom: 0; left: 0; right: 0;
        height: 70px;
        background: var(--card-bg);
        border-top: 1px solid var(--border);
        display: flex; justify-content: space-around;
        align-items: center;
        z-index: 100;
        padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-item {
        display: flex; flex-direction: column; align-items: center;
        font-size: 0.75rem; color: var(--text-sub);
        background: none; border: none; cursor: pointer;
        padding: 5px 15px;
    }
    .nav-item i { font-size: 1.4rem; margin-bottom: 4px; transition: transform 0.2s; }
    .nav-item.active { color: var(--primary); font-weight: 600; }
    .nav-item.active i { transform: translateY(-3px); }

    /* --- FLASHCARD SCENE --- */
    .scene { perspective: 1000px; width: 100%; height: 400px; margin: 20px 0; }
    .card {
        width: 100%; height: 100%; position: relative;
        transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0.2, 0.2, 1);
        cursor: pointer;
    }
    .card.is-flipped { transform: rotateY(180deg); }
    .card-face {
        position: absolute; width: 100%; height: 100%;
        backface-visibility: hidden;
        border-radius: 24px;
        background: var(--card-bg);
        border: 1px solid var(--border);
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        text-align: center; padding: 20px;
    }
    .card-back { transform: rotateY(180deg); background: var(--primary-light); border-color: var(--primary); }
    body.dark-mode .card-back { background: var(--primary-light); border-color: var(--primary); }

    .word-en { font-size: 2.5rem; font-weight: 800; color: var(--primary); margin-bottom: 5px; line-height: 1.2; }
    .word-ipa { font-size: 1.1rem; color: var(--text-sub); font-family: 'Times New Roman', serif; font-style: italic; margin-bottom: 20px; }
    .word-vn { font-size: 1.8rem; font-weight: 700; color: var(--text-main); margin-bottom: 10px; }
    .word-ex { font-size: 1rem; color: var(--text-sub); font-style: italic; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; width: 100%; }

    /* --- DASHBOARD STATS --- */
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
    .stat-card { padding: 15px; text-align: center; background: var(--card-bg); border-radius: var(--radius); border: 1px solid var(--border); }
    .stat-num { font-size: 1.5rem; font-weight: 800; color: var(--primary); }
    .stat-label { font-size: 0.85rem; color: var(--text-sub); }

    /* --- PROGRESS BAR --- */
    .progress-container { height: 6px; background: var(--border); border-radius: 10px; margin: 20px 0; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

    /* --- TOAST --- */
    #toast {
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        background: var(--text-main); color: var(--bg);
        padding: 10px 20px; border-radius: 30px; font-size: 0.9rem;
        opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 2000;
        box-shadow: 0 10px 15px rgba(0,0,0,0.2);
    }
</style>
</head>
<body>

<div id="view-home" class="view container active">
    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; margin-top: 10px;">
        <div>
            <div style="font-size:0.9rem; color:var(--text-sub);">Xin chào,</div>
            <h1 style="color:var(--primary);">Flashcard Pro</h1>
        </div>
        <button class="btn-ghost" onclick="toggleTheme()" style="font-size:1.2rem;"><i class="fas fa-adjust"></i></button>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-num" id="stat-due">0</div>
            <div class="stat-label">Cần ôn tập ngay</div>
        </div>
        <div class="stat-card">
            <div class="stat-num" id="stat-learned">0</div>
            <div class="stat-label">Đã thuộc</div>
        </div>
    </div>

    <div class="card-box" style="text-align: center; padding: 30px 20px;">
        <div class="text-sub" style="margin-bottom: 10px;">Chủ đề hiện tại</div>
        <h2 id="home-topic-name" style="margin-bottom: 5px; font-size: 1.8rem;">Chưa chọn</h2>
        <div id="home-topic-stats" class="text-sub" style="margin-bottom: 25px;">-- từ</div>

        <button class="btn btn-primary" id="btn-start-learn" onclick="startSession()" style="width: 100%; font-size: 1.1rem; padding: 15px;">
            <i class="fas fa-play"></i> BẮT ĐẦU HỌC & ÔN
        </button>
        <div style="font-size: 0.8rem; color: var(--text-sub); margin-top: 10px;">
            Hệ thống sẽ trộn <b id="cfg-disp-new">5</b> từ mới và <b id="cfg-disp-review">10</b> từ ôn tập.
        </div>
    </div>

    <div style="margin-top: 20px;">
        <h3 style="margin-bottom: 15px;">Biểu đồ ghi nhớ (SRS)</h3>
        <div class="card-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.9rem;">
                <span>Mới (New)</span> <span id="srs-lvl-0">0</span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.9rem;">
                <span style="color:var(--warning)">Đang học (Learning)</span> <span id="srs-lvl-1">0</span>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:8px; font-size:0.9rem;">
                <span style="color:var(--success)">Đã nhớ (Reviewing)</span> <span id="srs-lvl-2">0</span>
            </div>
             <div style="display:flex; justify-content:space-between; font-size:0.9rem;">
                <span style="color:var(--primary)">Thành thạo (Mastered)</span> <span id="srs-lvl-3">0</span>
            </div>
        </div>
    </div>
</div>

<div id="view-topics" class="view container">
    <h2 style="margin-bottom: 20px;">Danh sách Chủ đề</h2>
    <div id="topic-list" style="display: grid; gap: 15px;">
        <div class="card-box" style="text-align:center; padding: 40px;">Đang tải dữ liệu...</div>
    </div>
    
    <div class="card-box" style="margin-top: 20px;">
        <h3><i class="fab fa-github"></i> Nguồn dữ liệu</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
            <input type="text" id="gh-user" placeholder="User" value="ngxuanhai123">
            <input type="text" id="gh-repo" placeholder="Repo" value="tuvung">
        </div>
        <button class="btn btn-secondary" onclick="fetchTopics()" style="width:100%; margin-top:10px;">
            <i class="fas fa-sync"></i> Tải dữ liệu
        </button>
    </div>
</div>

<div id="view-learn" class="view container" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <button class="btn-ghost" onclick="endSession()"><i class="fas fa-times"></i> Thoát</button>
        <span style="font-weight: bold; font-size: 0.9rem;" id="session-counter">1/10</span>
        <button class="btn-ghost" onclick="speakCurrent()"><i class="fas fa-volume-up"></i></button>
    </div>

    <div class="progress-container">
        <div class="progress-fill" id="session-progress"></div>
    </div>

    <div class="scene">
        <div class="card" id="learn-card" onclick="flipCard()">
            <div class="card-face card-front">
                <span class="badge" id="card-type-badge" style="position:absolute; top:15px; right:15px; font-size:0.7rem; padding:4px 8px; border-radius:4px; background:var(--bg); color:var(--text-sub);">NEW</span>
                <div class="word-en" id="card-en">Word</div>
                <div class="word-ipa" id="card-ipa">/ipa/</div>
                <div class="text-sub" style="font-size: 0.8rem; margin-top: 20px;">Chạm để lật</div>
            </div>
            <div class="card-face card-back">
                <div class="word-vn" id="card-vn">Nghĩa</div>
                <div class="word-ex" id="card-ex">Ví dụ</div>
            </div>
        </div>
    </div>

    <div id="control-rating" style="display: none; opacity: 0; transition: opacity 0.3s;">
        <div style="text-align: center; font-size: 0.9rem; color: var(--text-sub); margin-bottom: 10px;">Bạn nhớ từ này thế nào?</div>
        <div class="srs-grid">
            <button class="btn btn-srs btn-again" onclick="rateCard('again')">
                <i class="fas fa-redo"></i>
                <span>Quên</span>
                <span style="font-size:0.65rem; opacity:0.7">&lt; 1p</span>
            </button>
            <button class="btn btn-srs btn-hard" onclick="rateCard('hard')">
                <i class="fas fa-exclamation"></i>
                <span>Khó</span>
                <span style="font-size:0.65rem; opacity:0.7" id="time-hard">10p</span>
            </button>
            <button class="btn btn-srs btn-good" onclick="rateCard('good')">
                <i class="fas fa-check"></i>
                <span>Được</span>
                <span style="font-size:0.65rem; opacity:0.7" id="time-good">1d</span>
            </button>
            <button class="btn btn-srs btn-easy" onclick="rateCard('easy')">
                <i class="fas fa-smile-beam"></i>
                <span>Dễ</span>
                <span style="font-size:0.65rem; opacity:0.7" id="time-easy">3d</span>
            </button>
        </div>
    </div>
</div>

<div id="view-settings" class="view container">
    <h2 style="margin-bottom: 20px;">Cấu hình học tập</h2>
    
    <div class="card-box">
        <h3><i class="fas fa-sliders-h"></i> Thiết lập phiên học</h3>
        <p class="text-sub" style="margin-bottom: 20px;">Điều chỉnh số lượng từ mỗi lần bấm "Bắt đầu".</p>

        <label style="font-weight:600; display:block; margin-bottom:5px;">Số từ mới (New Words): <span id="val-new" class="text-primary">5</span></label>
        <input type="range" id="range-new" min="0" max="20" value="5" style="width:100%; margin-bottom:20px;" oninput="updateSettingsUI()">

        <label style="font-weight:600; display:block; margin-bottom:5px;">Số từ ôn tập (Review): <span id="val-review" class="text-primary">10</span></label>
        <input type="range" id="range-review" min="0" max="50" value="10" style="width:100%; margin-bottom:20px;" oninput="updateSettingsUI()">
        
        <p class="text-sub" style="font-size:0.8rem;"><i class="fas fa-info-circle"></i> Việc chia nhỏ phiên học giúp não bộ ghi nhớ tốt hơn nhồi nhét.</p>
    </div>

    <div class="card-box">
        <h3><i class="fas fa-volume-up"></i> Giọng đọc (TTS)</h3>
        <select id="voice-select" onchange="saveVoiceSetting()"></select>
        <button class="btn btn-secondary" style="margin-top:10px;" onclick="testVoice()">Nghe thử</button>
    </div>

    <div class="card-box" style="border-color: var(--danger);">
        <h3 style="color:var(--danger)">Vùng nguy hiểm</h3>
        <p class="text-sub" style="margin-bottom:10px;">Xóa toàn bộ tiến độ học tập (Reset SRS).</p>
        <button class="btn" style="background:var(--danger); color:white;" onclick="resetProgress()">Reset Tiến độ</button>
    </div>
</div>

<div id="view-summary" class="view container" style="text-align: center; display: none;">
    <div style="margin-top: 50px;">
        <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success); margin-bottom: 20px;"></i>
        <h2 style="margin-bottom: 10px;">Hoàn thành phiên học!</h2>
        <p class="text-sub">Bạn vừa hoàn thành mục tiêu hôm nay.</p>
    </div>

    <div class="stats-grid" style="margin-top: 30px;">
        <div class="stat-card">
            <div class="stat-num text-primary" id="sum-new">0</div>
            <div class="stat-label">Từ mới đã học</div>
        </div>
        <div class="stat-card">
            <div class="stat-num text-success" id="sum-review">0</div>
            <div class="stat-label">Từ đã ôn tập</div>
        </div>
    </div>

    <button class="btn btn-primary" onclick="switchTab('view-home')" style="margin-top: 40px;">
        Về Trang chủ
    </button>
</div>


<nav class="nav-bar">
    <button class="nav-item active" onclick="switchTab('view-home')" data-target="view-home">
        <i class="fas fa-home"></i>
        <span>Học</span>
    </button>
    <button class="nav-item" onclick="switchTab('view-topics')" data-target="view-topics">
        <i class="fas fa-list"></i>
        <span>Chủ đề</span>
    </button>
    <button class="nav-item" onclick="switchTab('view-settings')" data-target="view-settings">
        <i class="fas fa-cog"></i>
        <span>Cài đặt</span>
    </button>
</nav>

<div id="toast">Thông báo</div>

<script>
    /* --- DATA STATE --- */
    let topicsData = {};
    let currentTopicKey = localStorage.getItem('current_topic') || null;
    let srsData = JSON.parse(localStorage.getItem('srs_db_v1') || '{}');
    
    // Config default
    let config = JSON.parse(localStorage.getItem('app_config') || '{"newPerSession": 5, "reviewPerSession": 10}');

    // Session State
    let sessionQueue = [];
    let currentCardIndex = 0;
    let sessionStats = { new: 0, review: 0 };
    let selectedVoiceURI = localStorage.getItem('voice_uri') || '';

    /* --- INITIALIZATION --- */
    window.onload = function() {
        loadTheme();
        updateSettingsUI(true); // Load values to UI
        fetchTopics();
        setupVoices();
        updateHomeStats();
        
        // Hide nav on Learn view for focus
        // (Optional: Handled in switchTab)
    };

    /* --- THEME --- */
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('dark_mode', document.body.classList.contains('dark-mode'));
    }
    function loadTheme() {
        if(localStorage.getItem('dark_mode') === 'true') document.body.classList.add('dark-mode');
    }

    /* --- NAVIGATION --- */
    function switchTab(viewId) {
        document.querySelectorAll('.view').forEach(el => {
            el.classList.remove('active');
            el.style.display = 'none';
        });
        const target = document.getElementById(viewId);
        target.style.display = 'block';
        setTimeout(() => target.classList.add('active'), 10);

        // Update Nav
        document.querySelectorAll('.nav-item').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.target === viewId);
        });

        // Specific View Logics
        if(viewId === 'view-home') updateHomeStats();
        if(viewId === 'view-topics') renderTopicList();
        
        // Hide nav bar when learning to avoid distraction (optional but good UX)
        const nav = document.querySelector('.nav-bar');
        if(viewId === 'view-learn') nav.style.display = 'none';
        else nav.style.display = 'flex';
    }

    /* --- SETTINGS --- */
    function updateSettingsUI(fromStorage = false) {
        const rangeNew = document.getElementById('range-new');
        const rangeReview = document.getElementById('range-review');
        
        if (fromStorage) {
            rangeNew.value = config.newPerSession;
            rangeReview.value = config.reviewPerSession;
        } else {
            config.newPerSession = parseInt(rangeNew.value);
            config.reviewPerSession = parseInt(rangeReview.value);
            localStorage.setItem('app_config', JSON.stringify(config));
        }

        document.getElementById('val-new').innerText = rangeNew.value;
        document.getElementById('val-review').innerText = rangeReview.value;
        
        // Update home screen display too
        document.getElementById('cfg-disp-new').innerText = config.newPerSession;
        document.getElementById('cfg-disp-review').innerText = config.reviewPerSession;
    }
    
    function resetProgress() {
        if(confirm("Bạn có chắc chắn muốn xóa toàn bộ tiến độ học tập? Hành động này không thể hoàn tác.")) {
            srsData = {};
            localStorage.setItem('srs_db_v1', JSON.stringify(srsData));
            alert("Đã reset!");
            updateHomeStats();
        }
    }

    /* --- GITHUB FETCH --- */
    async function fetchTopics() {
        const user = document.getElementById('gh-user').value;
        const repo = document.getElementById('gh-repo').value;
        const listDiv = document.getElementById('topic-list');
        
        localStorage.setItem('gh_user', user);
        localStorage.setItem('gh_repo', repo);

        try {
            const apiURL = `https://api.github.com/repos/${user}/${repo}/contents/`;
            const res = await fetch(apiURL);
            if(!res.ok) throw new Error("Không tìm thấy Repo");
            const files = await res.json();
            const jsonFiles = files.filter(f => f.name.endsWith('.json'));

            topicsData = {};
            
            for (const file of jsonFiles) {
                const raw = await fetch(file.download_url);
                const data = await raw.json();
                
                // Normalize data structure
                let words = Array.isArray(data) ? data : (data.words || []);
                if(words.length > 0) {
                    topicsData[file.name] = {
                        name: data.name || file.name.replace('.json','').replace(/_/g,' '),
                        words: words
                    };
                }
            }
            renderTopicList();
            
            // Auto select if none selected
            if (!currentTopicKey && Object.keys(topicsData).length > 0) {
                selectTopic(Object.keys(topicsData)[0]);
            } else {
                updateHomeStats();
            }

        } catch (err) {
            listDiv.innerHTML = `<div class="card-box" style="color:var(--danger)">Lỗi: ${err.message}</div>`;
        }
    }

    function renderTopicList() {
        const listDiv = document.getElementById('topic-list');
        listDiv.innerHTML = '';
        const keys = Object.keys(topicsData);
        if(keys.length === 0) {
            listDiv.innerHTML = '<div class="text-sub" style="text-align:center">Chưa có dữ liệu.</div>';
            return;
        }

        keys.forEach(key => {
            const topic = topicsData[key];
            const div = document.createElement('div');
            div.className = 'card-box';
            div.style.cursor = 'pointer';
            div.style.borderLeft = (key === currentTopicKey) ? '4px solid var(--primary)' : '1px solid var(--border)';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-weight:700; font-size:1.1rem;">${topic.name}</div>
                    <div class="text-sub">${topic.words.length} từ</div>
                </div>
            `;
            div.onclick = () => {
                selectTopic(key);
                switchTab('view-home');
            };
            listDiv.appendChild(div);
        });
    }

    function selectTopic(key) {
        currentTopicKey = key;
        localStorage.setItem('current_topic', key);
        updateHomeStats();
        showToast(`Đã chọn: ${topicsData[key].name}`);
    }

    /* --- LOGIC: SRS & STATS --- */
    function getWordKey(word) {
        // Unique ID based on English word + partial Viet
        const en = (word.english || '').toLowerCase().trim().replace(/\s+/g, '');
        return en; 
    }

    function updateHomeStats() {
        if (!currentTopicKey || !topicsData[currentTopicKey]) {
            document.getElementById('home-topic-name').innerText = "Vui lòng chọn chủ đề";
            return;
        }

        const topic = topicsData[currentTopicKey];
        document.getElementById('home-topic-name').innerText = topic.name;
        document.getElementById('home-topic-stats').innerText = `${topic.words.length} từ vựng`;

        // Calculate SRS Stats for this topic
        let due = 0, learned = 0;
        let levels = [0, 0, 0, 0]; // New, Learning, Review, Mastered
        
        topic.words.forEach(w => {
            const key = getWordKey(w);
            const data = srsData[key];
            
            if (!data) {
                levels[0]++; // New
            } else {
                if (data.dueDate <= Date.now()) due++;
                if (data.level >= 1) learned++;
                
                // Categorize for chart
                if (data.level === 0) levels[1]++; // Just started learning (failed once) or level 0
                else if (data.level < 4) levels[2]++; // Reviewing
                else levels[3]++; // Mastered
            }
        });

        document.getElementById('stat-due').innerText = due;
        document.getElementById('stat-learned').innerText = learned;
        
        document.getElementById('srs-lvl-0').innerText = levels[0];
        document.getElementById('srs-lvl-1').innerText = levels[1];
        document.getElementById('srs-lvl-2').innerText = levels[2];
        document.getElementById('srs-lvl-3').innerText = levels[3];
        
        const btnStart = document.getElementById('btn-start-learn');
        if (levels[0] === 0 && due === 0) {
            btnStart.innerText = "HỌC TỰ DO (ÔN TẬP SỚM)";
            btnStart.classList.remove('btn-primary');
            btnStart.classList.add('btn-secondary');
        } else {
            btnStart.innerText = "BẮT ĐẦU HỌC & ÔN";
            btnStart.classList.add('btn-primary');
            btnStart.classList.remove('btn-secondary');
        }
    }

    /* --- LOGIC: SESSION MANAGEMENT --- */
    function startSession() {
        if (!currentTopicKey) return alert("Chọn chủ đề trước!");
        
        const words = topicsData[currentTopicKey].words;
        const now = Date.now();
        
        let newCards = [];
        let reviewCards = [];
        
        // 1. Filter
        words.forEach(w => {
            const key = getWordKey(w);
            const data = srsData[key];
            
            if (!data) {
                newCards.push({ ...w, type: 'new', key: key });
            } else if (data.dueDate <= now) {
                reviewCards.push({ ...w, type: 'review', key: key, srs: data });
            }
        });

        // 2. Slice based on Config
        // Shuffle first to not always get 'A' words
        newCards.sort(() => 0.5 - Math.random());
        reviewCards.sort((a,b) => a.srs.dueDate - b.srs.dueDate); // Review oldest due first

        const sessionNew = newCards.slice(0, config.newPerSession);
        const sessionReview = reviewCards.slice(0, config.reviewPerSession);
        
        // 3. Combine
        sessionQueue = [...sessionReview, ...sessionNew];
        
        // Fallback: If Queue is empty but user wants to learn, fill with random reviews (Early Review)
        if (sessionQueue.length === 0) {
            if (confirm("Bạn đã hoàn thành bài học hôm nay! Bạn có muốn ôn tập thêm các từ chưa đến hạn không?")) {
                const learnedWords = words.filter(w => srsData[getWordKey(w)]);
                const randomReview = learnedWords.sort(() => 0.5 - Math.random()).slice(0, 15);
                sessionQueue = randomReview.map(w => ({ ...w, type: 'review', key: getWordKey(w) }));
            } else {
                return;
            }
        } else {
            // Shuffle the session mix
            sessionQueue.sort(() => 0.5 - Math.random());
        }

        if (sessionQueue.length === 0) return;

        // Start
        currentCardIndex = 0;
        sessionStats = { new: 0, review: 0 };
        switchTab('view-learn');
        renderCard();
    }

    function renderCard() {
        if (currentCardIndex >= sessionQueue.length) {
            finishSession();
            return;
        }

        const cardData = sessionQueue[currentCardIndex];
        
        // Reset UI
        const cardEl = document.getElementById('learn-card');
        cardEl.classList.remove('is-flipped');
        document.getElementById('control-rating').style.display = 'none';
        document.getElementById('control-rating').style.opacity = '0';
        
        // Fill content
        document.getElementById('card-en').innerText = cardData.english;
        document.getElementById('card-ipa').innerText = cardData.ipa || '';
        document.getElementById('card-vn').innerText = cardData.vietnamese;
        document.getElementById('card-ex').innerText = cardData.example || 'Không có ví dụ';
        
        // Badge
        const badge = document.getElementById('card-type-badge');
        if (cardData.type === 'new') {
            badge.innerText = 'TỪ MỚI';
            badge.style.background = 'var(--primary-light)';
            badge.style.color = 'var(--primary)';
        } else {
            badge.innerText = 'ÔN TẬP';
            badge.style.background = '#FEF3C7';
            badge.style.color = '#D97706';
        }

        // Progress
        document.getElementById('session-counter').innerText = `${currentCardIndex + 1}/${sessionQueue.length}`;
        const pct = ((currentCardIndex) / sessionQueue.length) * 100;
        document.getElementById('session-progress').style.width = `${pct}%`;

        // Update Future Times on Buttons (Visual Aid)
        updateButtonLabels(cardData.key);
        
        // Auto speak
        setTimeout(speakCurrent, 300);
    }

    function flipCard() {
        const cardEl = document.getElementById('learn-card');
        if (!cardEl.classList.contains('is-flipped')) {
            cardEl.classList.add('is-flipped');
            
            // Show ratings after short delay
            setTimeout(() => {
                const ctr = document.getElementById('control-rating');
                ctr.style.display = 'block';
                // Trigger reflow
                ctr.offsetHeight; 
                ctr.style.opacity = '1';
            }, 200);
        }
    }

    /* --- LOGIC: SRS ALGORITHM --- */
    // Simple interval multipliers
    const INTERVALS = {
        again: 1, // minutes (reset)
        hard: 10, // minutes
        good: 1440, // 1 day (minutes)
        easy: 4320  // 3 days (minutes)
    };

    function updateButtonLabels(key) {
        // Calculate theoretical next due date for visual feedback
        // Just static labels for simplicity in this version, 
        // or dynamic if we want to be fancy. Sticking to static class-based CSS text for now
        // to keep code clean, but we can update innerText if needed.
    }

    function rateCard(rating) {
        const card = sessionQueue[currentCardIndex];
        const key = card.key;
        
        // Initialize data if new
        if (!srsData[key]) {
            srsData[key] = { level: 0, interval: 0, dueDate: 0 };
            sessionStats.new++;
        } else {
            sessionStats.review++;
        }

        let data = srsData[key];
        const now = Date.now();

        // SRS Logic (Simplified Sm-2)
        if (rating === 'again') {
            data.level = 0;
            data.interval = 1; // 1 min
        } else if (rating === 'hard') {
            data.level = Math.max(0, data.level); // Keep level
            data.interval = 10; // 10 mins
        } else if (rating === 'good') {
            data.level += 1;
            // Level 1: 1d, Lvl 2: 3d, Lvl 3: 7d...
            if (data.level === 1) data.interval = 1440; // 1 day
            else if (data.level === 2) data.interval = 4320; // 3 days
            else data.interval = Math.ceil(data.interval * 2.5);
        } else if (rating === 'easy') {
            data.level += 2;
            if (data.level <= 1) data.interval = 4320; // Jump to 3 days
            else data.interval = Math.ceil(data.interval * 3.5); // Bonus multiplier
        }

        // Set Due Date (min -> ms)
        data.dueDate = now + (data.interval * 60 * 1000);
        
        // Save
        srsData[key] = data;
        localStorage.setItem('srs_db_v1', JSON.stringify(srsData));

        // Next
        currentCardIndex++;
        
        // If 'Again', maybe requeue at end of session? 
        // For simplicity, we just move on, but in real SRS, 'Again' cards appear again in 1 min.
        if (rating === 'again') {
            // Push back to end of queue to review again in this session
            sessionQueue.push(card);
            showToast("Sẽ nhắc lại từ này trong phiên này");
        }

        renderCard();
    }

    function endSession() {
        if(confirm("Dừng phiên học?")) {
            switchTab('view-home');
        }
    }

    function finishSession() {
        document.getElementById('sum-new').innerText = sessionStats.new;
        document.getElementById('sum-review').innerText = sessionStats.review;
        switchTab('view-summary');
    }

    /* --- UTILS: TTS & TOAST --- */
    function setupVoices() {
        const select = document.getElementById('voice-select');
        let voices = window.speechSynthesis.getVoices();
        
        if (voices.length === 0) {
            window.speechSynthesis.onvoiceschanged = setupVoices;
            return;
        }

        select.innerHTML = '';
        voices.filter(v => v.lang.includes('en')).forEach(v => {
            const opt = document.createElement('option');
            opt.value = v.voiceURI;
            opt.innerText = `${v.name} (${v.lang})`;
            if(v.voiceURI === selectedVoiceURI) opt.selected = true;
            select.appendChild(opt);
        });
    }

    function saveVoiceSetting() {
        selectedVoiceURI = document.getElementById('voice-select').value;
        localStorage.setItem('voice_uri', selectedVoiceURI);
    }

    function speakCurrent() {
        const card = sessionQueue[currentCardIndex];
        if (!card) return;
        
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(card.english);
        const voice = window.speechSynthesis.getVoices().find(v => v.voiceURI === selectedVoiceURI);
        if (voice) u.voice = voice;
        u.lang = 'en-US';
        u.rate = 0.9;
        window.speechSynthesis.speak(u);
    }
    
    function testVoice() {
         window.speechSynthesis.cancel();
         const u = new SpeechSynthesisUtterance("Hello, this is a voice test.");
         const voice = window.speechSynthesis.getVoices().find(v => v.voiceURI === document.getElementById('voice-select').value);
         if(voice) u.voice = voice;
         window.speechSynthesis.speak(u);
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2000);
    }

</script>
</body>
</html>
