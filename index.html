<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Flashcard Pro - Ultimate</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  /* --- RESET & VARIABLES --- */
  :root {
    --primary: #6c5ce7;
    --secondary: #a29bfe;
    --success: #00b894; /* Good/Easy */
    --warning: #fdcb6e; /* Hard */
    --danger: #ff7675;  /* Again */
    --dark: #2d3436;
    --light: #dfe6e9;
    --glass-bg: rgba(255, 255, 255, 0.75);
    --glass-border: rgba(255, 255, 255, 0.4);
    --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    --radius: 24px;
    --bg-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    --font-main: 'Nunito', sans-serif;
  }

  /* Dark Mode Variables override */
  body.dark-mode {
    --bg-gradient: linear-gradient(135deg, #2d3436 0%, #000000 74%);
    --glass-bg: rgba(30, 39, 46, 0.85);
    --glass-border: rgba(255, 255, 255, 0.1);
    --dark: #dfe6e9; /* Text becomes light */
    --light: #2d3436;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; font-family: var(--font-main); }

  body {
    background: var(--bg-gradient);
    background-attachment: fixed; /* Giữ background đứng yên khi cuộn */
    min-height: 100vh;
    color: var(--dark);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-bottom: 90px;
    transition: all 0.5s ease;
    overflow-x: hidden;
  }

  /* --- UTILITIES --- */
  .glass-panel {
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-radius: var(--radius);
    border: 1px solid var(--glass-border);
    box-shadow: var(--shadow);
    padding: 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .btn {
    border: none;
    padding: 12px 24px;
    border-radius: 50px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    background: white;
    color: var(--primary);
  }
  .btn:active { transform: scale(0.95); }
  
  .btn-primary { background: linear-gradient(45deg, #6c5ce7, #a29bfe); color: white; }
  .btn-success { background: linear-gradient(45deg, #00b894, #55efc4); color: white; }
  .btn-danger { background: linear-gradient(45deg, #d63031, #ff7675); color: white; }
  .btn-warning { background: linear-gradient(45deg, #e17055, #fab1a0); color: white; }
  
  /* --- LAYOUT --- */
  header {
    text-align: center; margin: 30px 0 20px 0; width: 100%; z-index: 10;
  }
  h1 { 
    font-weight: 900; font-size: 2.5rem; 
    background: -webkit-linear-gradient(45deg, #6c5ce7, #0984e3);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    text-shadow: 0 5px 15px rgba(108, 92, 231, 0.2);
  }
  
  .view-container { width: 90%; max-width: 600px; display: none; animation: slideUp 0.5s ease; }
  .view-container.active { display: block; }
  
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  /* --- DASHBOARD --- */
  .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 20px; }
  .stat-card { text-align: center; padding: 15px 10px; }
  .stat-num { font-size: 1.5rem; font-weight: 800; display: block; margin-bottom: 5px; }
  .stat-label { font-size: 0.8rem; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }

  .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 25px; }
  .menu-btn {
    flex-direction: column; padding: 20px; aspect-ratio: 1.4;
    font-size: 1.1rem; color: var(--dark);
    background: rgba(255,255,255,0.6);
  }
  .menu-btn i { font-size: 2rem; margin-bottom: 10px; color: var(--primary); }
  .menu-btn.large { grid-column: 1 / -1; aspect-ratio: 3; flex-direction: row; background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.6)); }
  
  /* --- GAME OVERLAY --- */
  #gameOverlay {
    position: fixed; inset: 0; z-index: 1000;
    background: var(--bg-gradient);
    display: none; flex-direction: column;
    padding: 20px;
  }
  .progress-bar-container { width: 100%; height: 8px; background: rgba(0,0,0,0.1); border-radius: 10px; margin: 10px 0 20px; overflow: hidden; }
  .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.3s; }
  
  /* --- FLASHCARD --- */
  .scene { width: 100%; max-width: 400px; height: 450px; perspective: 1000px; margin: 0 auto; }
  .card { width: 100%; height: 100%; position: relative; transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1); transform-style: preserve-3d; cursor: pointer; }
  .card.is-flipped { transform: rotateY(180deg); }
  
  .card__face {
    position: absolute; inset: 0;
    backface-visibility: hidden;
    border-radius: 30px;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    padding: 30px; text-align: center;
    background: rgba(255, 255, 255, 0.9);
    box-shadow: 0 20px 50px rgba(0,0,0,0.1);
    border: 1px solid rgba(255,255,255,0.5);
  }
  .card__face--back { transform: rotateY(180deg); border: 2px solid var(--primary); background: #fdfdfd; }
  
  .word-en { font-size: 2.8rem; font-weight: 800; color: var(--primary); margin-bottom: 10px; }
  .word-ipa { font-size: 1.3rem; color: #636e72; font-family: serif; font-style: italic; opacity: 0.8; }
  .word-vn { font-size: 2.2rem; font-weight: 700; color: #2d3436; margin-bottom: 15px; }
  .word-ex { font-size: 1.1rem; color: #636e72; font-style: italic; background: rgba(0,0,0,0.05); padding: 10px; border-radius: 10px; width: 100%;}
  
  .srs-buttons {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
    width: 100%; max-width: 450px; margin: 20px auto 0;
  }
  .srs-btn {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 10px 5px; border-radius: 15px; cursor: pointer;
    background: rgba(255,255,255,0.8); transition: transform 0.2s;
    border: 1px solid rgba(0,0,0,0.05);
  }
  .srs-btn:active { transform: scale(0.9); }
  .srs-btn div:first-child { font-weight: 800; font-size: 0.9rem; margin-bottom: 2px;}
  .srs-btn div:last-child { font-size: 0.7rem; opacity: 0.7; }

  /* Màu riêng cho nút SRS */
  .srs-again { color: var(--danger); border-bottom: 3px solid var(--danger); }
  .srs-hard { color: var(--warning); border-bottom: 3px solid var(--warning); }
  .srs-good { color: var(--primary); border-bottom: 3px solid var(--primary); }
  .srs-easy { color: var(--success); border-bottom: 3px solid var(--success); }

  /* --- ANIMATIONS --- */
  @keyframes shake { 0%,100%{transform:translateX(0)} 10%,30%,50%,70%,90%{transform:translateX(-5px)} 20%,40%,60%,80%{transform:translateX(5px)} }
  .shake { animation: shake 0.4s ease-in-out; }

  /* --- CONFETTI CANVAS --- */
  #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2000; }

  /* --- BOTTOM NAV --- */
  .nav-bar {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
    width: 90%; max-width: 400px; height: 65px;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-radius: 40px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    display: flex; justify-content: space-around; align-items: center;
    z-index: 100;
  }
  .nav-item {
    font-size: 1.5rem; color: #b2bec3; transition: 0.3s; position: relative;
    width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%;
  }
  .nav-item.active { color: white; background: var(--primary); transform: translateY(-10px); box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4); }

  /* --- MODAL --- */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 3000;
    display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px);
  }
  .modal-box {
    width: 90%; max-width: 400px; background: white; border-radius: 20px; padding: 30px;
    text-align: center; animation: zoomIn 0.3s;
  }
  @keyframes zoomIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

  /* --- TOPIC LIST --- */
  .topic-item {
    display: flex; justify-content: space-between; align-items: center;
    padding: 15px; margin-bottom: 10px; cursor: pointer;
    border-radius: 15px; background: rgba(255,255,255,0.5);
    transition: 0.2s;
  }
  .topic-item:hover { background: white; transform: translateX(5px); }
  .topic-item.active { border: 2px solid var(--primary); background: white; }

</style>
</head>
<body onload="initApp()">
<canvas id="confetti-canvas"></canvas>

<header>
  <h1>Flashcard Pro</h1>
  <div style="font-size: 0.9rem; opacity: 0.7; margin-top: -5px;">Học thông minh - Nhớ lâu dài</div>
</header>

<div id="homeView" class="view-container active">
  <div class="glass-panel" style="position: relative; overflow: hidden;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <div style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; opacity:0.6;">Chủ đề hiện tại</div>
        <div id="currentTopicName" style="font-size:1.4rem; font-weight:800; color:var(--primary); margin: 5px 0 0;">(Chưa chọn)</div>
      </div>
      <div onclick="switchView('topicView')" style="padding:10px; background:rgba(0,0,0,0.05); border-radius:50%; cursor:pointer;">
        <i class="fas fa-cog"></i>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <span id="statNew" class="stat-num" style="color:var(--primary)">0</span>
        <span class="stat-label">Mới</span>
      </div>
      <div class="stat-card">
        <span id="statDue" class="stat-num" style="color:var(--danger)">0</span>
        <span class="stat-label">Cần ôn</span>
      </div>
      <div class="stat-card">
        <span id="statMastered" class="stat-num" style="color:var(--success)">0</span>
        <span class="stat-label">Đã thuộc</span>
      </div>
    </div>
  </div>

  <div class="menu-grid">
    <button class="menu-btn glass-panel large" onclick="startSession()">
      <div style="display:flex; align-items:center; gap:15px; width:100%; justify-content:center;">
        <i class="fas fa-brain" style="font-size:2.5rem; margin:0;"></i>
        <div style="text-align:left;">
          <div style="font-weight:800;">Bắt đầu học ngay</div>
          <div style="font-size:0.8rem; opacity:0.7;">Thuật toán SRS thông minh</div>
        </div>
      </div>
    </button>
    
    <button class="menu-btn glass-panel" onclick="startMiniGame('quiz')">
      <i class="fas fa-check-double"></i> Trắc nghiệm
    </button>
    <button class="menu-btn glass-panel" onclick="startMiniGame('fill')">
      <i class="fas fa-pen-fancy"></i> Điền từ
    </button>
  </div>
</div>

<div id="topicView" class="view-container">
  <h2 style="margin-bottom:20px;">Danh sách chủ đề</h2>
  
  <div class="glass-panel" style="margin-bottom: 20px;">
    <div style="margin-bottom:10px; font-weight:bold;">Kết nối GitHub</div>
    <div style="display:flex; gap:10px;">
        <input type="text" id="gh-user" placeholder="Username" value="ngxuanhai123" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ccc;">
        <input type="text" id="gh-repo" placeholder="Repo" value="tuvung" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ccc;">
    </div>
    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="fetchData(true)">
      <i class="fas fa-sync-alt"></i> Cập nhật dữ liệu
    </button>
  </div>

  <div id="topicListContainer"></div>
</div>

<div id="settingsView" class="view-container">
    <h2 style="margin-bottom:20px;">Cài đặt & Hướng dẫn</h2>
    <div class="glass-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <span>Chế độ Tối (Dark Mode)</span>
            <button class="btn" style="padding:5px 15px;" onclick="toggleTheme()">
                <i id="themeIcon" class="fas fa-moon"></i>
            </button>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <span>Âm thanh (Sound)</span>
            <button class="btn" style="padding:5px 15px;" onclick="toggleMute()">
                <i id="muteIcon" class="fas fa-volume-up"></i>
            </button>
        </div>
        <hr style="opacity:0.2; margin:15px 0;">
        <h3 style="margin-bottom:10px; font-size:1rem; color:var(--primary);">Giải thích nút bấm</h3>
        <ul style="list-style:none; font-size:0.9rem; line-height:1.6;">
            <li><strong style="color:var(--danger)">Quên:</strong> Chưa thuộc, sẽ hỏi lại ngay trong buổi này.</li>
            <li><strong style="color:var(--warning)">Khó:</strong> Tạm nhớ, lặp lại sớm (ngắn hạn).</li>
            <li><strong style="color:var(--primary)">Tốt:</strong> Nhớ được, lặp lại theo lịch chuẩn.</li>
            <li><strong style="color:var(--success)">Dễ:</strong> Rất dễ, lặp lại sau thời gian dài.</li>
            <li><strong style="color:gray"><i class="fas fa-check-circle"></i> Mastered:</strong> Đánh dấu đã thuộc lòng, vĩnh viễn không hỏi lại.</li>
        </ul>
    </div>
</div>

<div class="nav-bar">
  <div class="nav-item active" onclick="switchView('homeView')"><i class="fas fa-home"></i></div>
  <div class="nav-item" onclick="switchView('topicView')"><i class="fas fa-list"></i></div>
  <div class="nav-item" onclick="switchView('settingsView')"><i class="fas fa-user-cog"></i></div>
</div>

<div id="gameOverlay">
    <div style="display:flex; justify-content:space-between; align-items:center; width:100%; max-width:600px; margin: 0 auto;">
        <div onclick="closeGame()" style="padding:10px; cursor:pointer;"><i class="fas fa-times" style="font-size:1.5rem;"></i></div>
        <div style="font-weight:bold; font-size:0.9rem; opacity:0.8;">SESSION ĐANG DIỄN RA</div>
        <div style="width:30px;"></div> </div>
    
    <div style="width:100%; max-width:600px; margin: 0 auto;">
        <div class="progress-bar-container">
            <div id="sessionProgress" class="progress-fill"></div>
        </div>
    </div>

    <div id="gameContent" style="flex-grow:1; display:flex; flex-direction:column; justify-content:center; align-items:center; width:100%;">
        </div>
</div>

<div id="toast" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:12px 25px; border-radius:30px; z-index:4000; opacity:0; transition:0.3s; pointer-events:none;">Thông báo</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
    // --- STATE MANAGEMENT ---
    let appData = {
        topics: {},
        currentTopicKey: localStorage.getItem('curTopic') || null,
        srs: JSON.parse(localStorage.getItem('srsData_v2') || '{}'),
        mastered: JSON.parse(localStorage.getItem('masteredData') || '{}'),
        settings: {
            darkMode: localStorage.getItem('darkMode') === 'true',
            muted: localStorage.getItem('muted') === 'true',
            newLimit: 5,
            reviewLimit: 15
        }
    };

    let session = {
        queue: [], // Danh sách từ trong phiên hiện tại
        index: 0,
        mode: 'smart', // 'smart', 'quiz', 'fill'
        isFlipped: false,
        processing: false
    };

    // --- INIT ---
    function initApp() {
        applyTheme();
        fetchData(); // Load data from GitHub or Cache
        setupIcons();
        switchView('homeView');
    }

    function applyTheme() {
        document.body.classList.toggle('dark-mode', appData.settings.darkMode);
    }
    
    function setupIcons() {
        document.getElementById('themeIcon').className = appData.settings.darkMode ? 'fas fa-sun' : 'fas fa-moon';
        document.getElementById('muteIcon').className = appData.settings.muted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
    }

    function showToast(msg, type='info') {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.opacity = 1;
        t.style.top = '20px';
        if(type==='success') t.style.background = 'var(--success)';
        else if(type==='error') t.style.background = 'var(--danger)';
        else t.style.background = 'rgba(0,0,0,0.8)';
        
        setTimeout(() => {
            t.style.opacity = 0;
            t.style.top = '10px';
        }, 2000);
    }

    // --- DATA & SYNC ---
    async function fetchData(manual = false) {
        if(manual) showToast("Đang tải dữ liệu...", 'info');
        const user = document.getElementById('gh-user').value;
        const repo = document.getElementById('gh-repo').value;
        
        try {
            const listUrl = `https://api.github.com/repos/${user}/${repo}/contents/`;
            const res = await fetch(listUrl);
            if(!res.ok) throw new Error("GitHub Error");
            const files = await res.json();
            
            appData.topics = {};
            for(let f of files) {
                if(f.name.endsWith('.json')) {
                    const raw = await fetch(f.download_url);
                    const data = await raw.json();
                    let words = Array.isArray(data) ? data : (data.words || []);
                    if(words.length) {
                        appData.topics[f.name] = { 
                            name: (data.name || f.name.replace('.json','')).replace(/_/g,' '),
                            words: words.map(w => ({...w, key: generateKey(w)}))
                        };
                    }
                }
            }
            if(!appData.currentTopicKey && Object.keys(appData.topics).length > 0) {
                appData.currentTopicKey = Object.keys(appData.topics)[0];
            }
            if(manual) showToast("Cập nhật thành công!", 'success');
            renderDashboard();
            renderTopicList();
        } catch(e) {
            console.error(e);
            if(manual) showToast("Lỗi tải dữ liệu. Kiểm tra mạng/GitHub", 'error');
        }
    }
    
    function generateKey(w) {
        return (w.english + w.vietnamese).replace(/\s/g,'').toLowerCase();
    }

    // --- DASHBOARD LOGIC ---
    function renderDashboard() {
        if(!appData.currentTopicKey || !appData.topics[appData.currentTopicKey]) return;
        const topic = appData.topics[appData.currentTopicKey];
        document.getElementById('currentTopicName').innerText = topic.name;

        let cntNew = 0, cntDue = 0, cntMast = 0;
        const now = Date.now();
        
        topic.words.forEach(w => {
            if(appData.mastered[w.key]) cntMast++;
            else {
                const srs = appData.srs[w.key];
                if(!srs) cntNew++;
                else if(srs.dueDate <= now) cntDue++;
            }
        });
        
        animateValue('statNew', cntNew);
        animateValue('statDue', cntDue);
        animateValue('statMastered', cntMast);
    }

    function animateValue(id, end) {
        const obj = document.getElementById(id);
        const start = parseInt(obj.innerText);
        if(start === end) return;
        let current = start;
        const step = end > start ? 1 : -1;
        const timer = setInterval(() => {
            current += step;
            obj.innerText = current;
            if (current === end) clearInterval(timer);
        }, 30);
    }

    // --- SESSION ALGORITHM (CORE) ---
    function startSession() {
        if(!appData.currentTopicKey) return showToast("Chọn chủ đề trước!", 'error');
        
        const topicWords = appData.topics[appData.currentTopicKey].words;
        const now = Date.now();
        
        // 1. Filter Out Mastered
        const activeWords = topicWords.filter(w => !appData.mastered[w.key]);
        
        // 2. Identify Groups
        const dueWords = activeWords.filter(w => appData.srs[w.key] && appData.srs[w.key].dueDate <= now);
        const newWords = activeWords.filter(w => !appData.srs[w.key]);
        
        // 3. Prioritize: Due (Overdue first) -> New
        // Sort Due words by overdue time (most overdue first)
        dueWords.sort((a,b) => appData.srs[a.key].dueDate - appData.srs[b.key].dueDate);
        
        // Take Batch
        const batchDue = dueWords.slice(0, appData.settings.reviewLimit);
        const batchNew = newWords.slice(0, appData.settings.newLimit);
        
        // Combine & Shuffle
        let queue = [...batchDue, ...batchNew];
        
        // Scientific Shuffle: Ensure not same word twice in a row if possible (not needed for batch this small, just standard shuffle)
        queue.sort(() => Math.random() - 0.5);
        
        if(queue.length === 0) {
            if(activeWords.length === 0) showToast("Bạn đã thuộc hết chủ đề này! Xuất sắc!", 'success');
            else showToast("Chưa có từ nào đến hạn ôn tập.", 'info');
            return;
        }

        session.queue = queue;
        session.index = 0;
        session.mode = 'smart';
        
        document.getElementById('gameOverlay').style.display = 'flex';
        renderFlashcard();
    }

    // --- FLASHCARD UI & LOGIC ---
    function renderFlashcard() {
        if(session.index >= session.queue.length) {
            finishSession();
            return;
        }
        
        const w = session.queue[session.index];
        session.isFlipped = false;
        session.processing = false;
        updateProgress();

        const html = `
            <div class="scene">
                <div class="card" id="flashcard" onclick="flipCard()">
                    <div class="card__face card__face--front">
                        <div class="word-en">${w.english}</div>
                        <div class="word-ipa">${w.ipa || ''}</div>
                        <div style="font-size:0.8rem; opacity:0.6; margin-top:20px;">(Chạm để xem nghĩa)</div>
                        <div onclick="event.stopPropagation(); speak('${w.english}')" class="btn" style="width:40px; height:40px; border-radius:50%; margin-top:20px; padding:0; background:rgba(108, 92, 231, 0.1); color:var(--primary);"><i class="fas fa-volume-up"></i></div>
                    </div>
                    <div class="card__face card__face--back">
                        <div class="word-vn">${w.vietnamese}</div>
                        <div class="word-ex">"${w.example || '...'}"</div>
                        <div onclick="event.stopPropagation(); toggleMastered()" class="btn" style="margin-top:15px; background:transparent; color:#b2bec3; font-size:0.8rem; border:1px solid #dfe6e9;">
                            <i class="fas fa-check-circle"></i> Đánh dấu đã thuộc
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="srs-buttons" id="srsControls" style="opacity:0.3; pointer-events:none; transition:0.3s;">
                <div class="srs-btn srs-again" onclick="rateWord(1)"><div>Quên</div><div><1p</div></div>
                <div class="srs-btn srs-hard" onclick="rateWord(2)"><div>Khó</div><div>2 ngày</div></div>
                <div class="srs-btn srs-good" onclick="rateWord(3)"><div>Tốt</div><div>4 ngày</div></div>
                <div class="srs-btn srs-easy" onclick="rateWord(4)"><div>Dễ</div><div>7 ngày</div></div>
            </div>
        `;
        document.getElementById('gameContent').innerHTML = html;
        
        // Auto speak logic if needed
        setTimeout(() => speak(w.english), 400);
    }

    function flipCard() {
        if(session.processing) return;
        const card = document.getElementById('flashcard');
        const ctrls = document.getElementById('srsControls');
        
        session.isFlipped = !session.isFlipped;
        if(session.isFlipped) {
            card.classList.add('is-flipped');
            // Enable SRS buttons
            ctrls.style.opacity = 1;
            ctrls.style.pointerEvents = 'auto';
            playSound('flip');
        } else {
            card.classList.remove('is-flipped');
            ctrls.style.opacity = 0.3;
            ctrls.style.pointerEvents = 'none';
        }
    }

    // --- SRS ALGORITHM (SUPERMEMO-2 INSPIRED) ---
    function rateWord(rating) {
        if(session.processing) return;
        session.processing = true;

        const w = session.queue[session.index];
        const key = w.key;
        let data = appData.srs[key] || { interval: 0, ease: 2.5, dueDate: 0, streak: 0 };
        
        // Rating: 1=Again, 2=Hard, 3=Good, 4=Easy
        if (rating === 1) { // AGAIN (Quên)
            playSound('wrong');
            data.interval = 0; // Reset
            data.streak = 0;
            // Re-queue this word at the end of session to review again immediately
            session.queue.push(w);
            showToast("Sẽ hỏi lại từ này ngay!", 'error');
        } else {
            playSound('correct');
            // Algorithm logic
            if (data.interval === 0) {
                if(rating === 2) data.interval = 1;      // Hard -> 1 day
                else if(rating === 3) data.interval = 1; // Good -> 1 day
                else if(rating === 4) data.interval = 3; // Easy -> 3 days
            } else {
                // Adjust Ease Factor
                // q: 1=0, 2=3, 3=4, 4=5 (mapping UI rating to SM2 rating roughly)
                // Let's simplify:
                // Hard (2) -> Ease decreases slightly, Interval * 1.2
                // Good (3) -> Ease stays, Interval * Ease
                // Easy (4) -> Ease increases, Interval * Ease * 1.3
                
                if (rating === 2) {
                    data.ease = Math.max(1.3, data.ease - 0.15);
                    data.interval = Math.ceil(data.interval * 1.2);
                } else if (rating === 3) {
                    data.interval = Math.ceil(data.interval * data.ease);
                } else if (rating === 4) {
                    data.ease += 0.15;
                    data.interval = Math.ceil(data.interval * data.ease * 1.3);
                }
            }
            data.streak++;
            showToast("Đã lưu tiến độ!", 'success');
        }

        // Calculate Due Date (ms)
        // Note: interval is in days. If interval is 0, it means <1 day (but we handle <1day inside session)
        // For database storage, we only care about next calendar review
        data.dueDate = Date.now() + (data.interval * 24 * 60 * 60 * 1000);
        
        appData.srs[key] = data;
        saveData();

        setTimeout(() => {
            session.index++;
            if(session.mode === 'smart') renderFlashcard();
            else if(session.mode === 'quiz') nextQuiz();
            else if(session.mode === 'fill') nextFill();
        }, 600);
    }
    
    function toggleMastered() {
        const w = session.queue[session.index];
        appData.mastered[w.key] = true;
        delete appData.srs[w.key];
        saveData();
        showToast("Đã thuộc! Từ này sẽ không xuất hiện lại.", 'success');
        confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 } });
        
        session.index++;
        setTimeout(renderFlashcard, 800);
    }

    // --- HELPER FUNCTIONS ---
    function updateProgress() {
        const pct = ((session.index) / session.queue.length) * 100;
        document.getElementById('sessionProgress').style.width = `${pct}%`;
    }
    
    function saveData() {
        localStorage.setItem('srsData_v2', JSON.stringify(appData.srs));
        localStorage.setItem('masteredData', JSON.stringify(appData.mastered));
        renderDashboard();
    }
    
    function playSound(type) {
        if(appData.settings.muted) return;
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.connect(g); g.connect(ctx.destination);
        
        if(type==='correct') {
            osc.frequency.setValueAtTime(600, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
            g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            osc.start(); osc.stop(ctx.currentTime+0.3);
        } else if(type==='wrong') {
            osc.type='sawtooth';
            osc.frequency.setValueAtTime(150, ctx.currentTime);
            osc.frequency.linearRampToValueAtTime(100, ctx.currentTime + 0.2);
            g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            osc.start(); osc.stop(ctx.currentTime+0.3);
        } else {
            // Flip
            osc.frequency.setValueAtTime(300, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
            osc.start(); osc.stop(ctx.currentTime+0.1);
        }
    }
    
    function speak(text) {
        if(appData.settings.muted) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US';
        window.speechSynthesis.speak(u);
    }

    function finishSession() {
        document.getElementById('gameContent').innerHTML = `
            <div style="text-align:center; animation: zoomIn 0.5s;">
                <i class="fas fa-trophy" style="font-size:4rem; color:var(--warning); margin-bottom:20px;"></i>
                <h2>Hoàn thành xuất sắc!</h2>
                <p style="margin-bottom:20px;">Bạn đã ôn tập xong danh sách hiện tại.</p>
                <button class="btn btn-primary" onclick="closeGame()">Về trang chủ</button>
            </div>
        `;
        confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 } });
        playSound('correct');
    }

    function closeGame() {
        document.getElementById('gameOverlay').style.display = 'none';
        renderDashboard();
    }

    // --- MINI GAMES (BASIC LOGIC) ---
    function startMiniGame(mode) {
        if(!appData.currentTopicKey) return showToast("Chọn chủ đề trước!");
        const activeWords = appData.topics[appData.currentTopicKey].words.filter(w => !appData.mastered[w.key]);
        if(activeWords.length < 4) return showToast("Cần ít nhất 4 từ để chơi!");
        
        session.queue = activeWords.sort(() => Math.random() - 0.5).slice(0, 10);
        session.index = 0;
        session.mode = mode;
        document.getElementById('gameOverlay').style.display = 'flex';
        
        if(mode === 'quiz') nextQuiz();
        else nextFill();
    }

    function nextQuiz() {
        if(session.index >= session.queue.length) { finishSession(); return; }
        updateProgress();
        const w = session.queue[session.index];
        
        // Generate distractors
        const allWords = appData.topics[appData.currentTopicKey].words;
        let opts = [w];
        while(opts.length < 4) {
            const r = allWords[Math.floor(Math.random()*allWords.length)];
            if(!opts.includes(r)) opts.push(r);
        }
        opts.sort(()=>Math.random()-0.5);
        
        let html = `<h2 style="font-size:2.5rem; color:var(--primary); margin-bottom:30px;">${w.english}</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; width:100%;">`;
        
        opts.forEach(o => {
            html += `<button class="glass-panel" style="padding:20px; font-size:1.1rem; cursor:pointer; font-weight:bold; color:var(--dark);" onclick="checkQuiz(this, '${o.key}', '${w.key}')">${o.vietnamese}</button>`;
        });
        html += `</div>`;
        
        document.getElementById('gameContent').innerHTML = html;
        speak(w.english);
    }

    function checkQuiz(btn, key, correctKey) {
        if(key === correctKey) {
            btn.style.background = 'var(--success)';
            btn.style.color = 'white';
            playSound('correct');
            session.index++;
            setTimeout(nextQuiz, 800);
        } else {
            btn.style.background = 'var(--danger)';
            btn.style.color = 'white';
            btn.classList.add('shake');
            playSound('wrong');
        }
    }

    function nextFill() {
        if(session.index >= session.queue.length) { finishSession(); return; }
        updateProgress();
        const w = session.queue[session.index];
        const hidden = w.english.replace(/[a-zA-Z]/g, '_');
        
        const html = `
            <h3 style="margin-bottom:10px;">Điền từ còn thiếu</h3>
            <div style="font-size:1.5rem; margin-bottom:20px;">${w.vietnamese}</div>
            <div style="font-size:2rem; letter-spacing:5px; margin-bottom:20px; font-family:monospace;">${hidden}</div>
            <input type="text" id="fillInput" class="glass-panel" style="width:80%; font-size:1.5rem; text-align:center; margin-bottom:20px;" placeholder="...">
            <button class="btn btn-primary" onclick="checkFill('${w.english}')">Kiểm tra</button>
        `;
        document.getElementById('gameContent').innerHTML = html;
        document.getElementById('fillInput').focus();
    }
    
    function checkFill(ans) {
        const inp = document.getElementById('fillInput');
        if(inp.value.toLowerCase().trim() === ans.toLowerCase().trim()) {
            inp.style.border = "2px solid var(--success)";
            playSound('correct');
            session.index++;
            setTimeout(nextFill, 1000);
        } else {
            inp.style.border = "2px solid var(--danger)";
            inp.classList.add('shake');
            showToast(`Sai rồi: ${ans}`, 'error');
            playSound('wrong');
        }
    }

    // --- SETTINGS UI ---
    function toggleTheme() {
        appData.settings.darkMode = !appData.settings.darkMode;
        localStorage.setItem('darkMode', appData.settings.darkMode);
        applyTheme();
        setupIcons();
    }
    function toggleMute() {
        appData.settings.muted = !appData.settings.muted;
        localStorage.setItem('muted', appData.settings.muted);
        setupIcons();
    }

    function renderTopicList() {
        const c = document.getElementById('topicListContainer');
        c.innerHTML = '';
        Object.keys(appData.topics).forEach(key => {
            const t = appData.topics[key];
            const div = document.createElement('div');
            div.className = `topic-item ${key===appData.currentTopicKey ? 'active':''}`;
            div.innerHTML = `<span>${t.name}</span> <span style="font-size:0.8rem; opacity:0.6">${t.words.length} từ</span>`;
            div.onclick = () => {
                appData.currentTopicKey = key;
                localStorage.setItem('curTopic', key);
                renderTopicList();
                renderDashboard();
                showToast(`Đã chọn: ${t.name}`, 'success');
            };
            c.appendChild(div);
        });
    }

    function switchView(id) {
        document.querySelectorAll('.view-container').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        if(id === 'homeView') document.querySelector('.nav-item:nth-child(1)').classList.add('active');
        if(id === 'topicView') document.querySelector('.nav-item:nth-child(2)').classList.add('active');
        if(id === 'settingsView') document.querySelector('.nav-item:nth-child(3)').classList.add('active');
    }
</script>
</body>
</html>
